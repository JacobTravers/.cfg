#!/bin/sh
output=$(mktemp --directory "${TMPDIR:-/tmp}"/kak-grep.XXXXXXXX)/fifo
mkfifo "$output"
(rg --column --smart-case "$@" | tr --delete '\r' >"$output" 2>&1 &) >/dev/null 2>&1 </dev/null
kak -e "edit! -fifo $output *grep*
  set-option buffer filetype grep
  set-option buffer grep_current_line 0
  hook -always -once buffer BufCloseFifo .* %{ nop %sh{ rm -r $(dirname $output) } }"
